# Middleware Configuration
# This file allows customization of middleware behavior

# Error Handling
error_handler:
  enabled: true
  config:
    debug: ${DEBUG:-false}
    log_errors: true
    include_traceback: false
    custom_error_pages: true

# Security Headers
security:
  enabled: ${SECURITY_HEADERS_ENABLED:-true}
  config:
    csp_enabled: true
    hsts_enabled: true
    xss_protection: true
    content_type_nosniff: true
    frame_options: "DENY"
    referrer_policy: "strict-origin-when-cross-origin"

# CORS
cors:
  enabled: true
  config:
    allow_origins:
      - "http://localhost:3000"
      - "http://localhost:3001"
      - "https://goat-prediction.com"
      - "https://admin.goat-prediction.com"
      - "https://api.goat-prediction.com"
    allow_credentials: true
    allow_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "PATCH"
      - "OPTIONS"
    allow_headers:
      - "*"
    expose_headers:
      - "X-Request-ID"
      - "X-Response-Time"
    max_age: 600

# Request Timeout
timeout:
  enabled: true
  config:
    timeout: ${REQUEST_TIMEOUT:-30}
    timeout_message: "Request timeout"
    on_timeout: "raise"  # raise, return, or callback

# Rate Limiting
rate_limiter:
  enabled: ${RATE_LIMIT_ENABLED:-true}
  config:
    storage: "redis"  # redis, memory, or database
    strategy: "fixed-window"  # fixed-window, sliding-window, token-bucket
    default_limit: ${RATE_LIMIT_DEFAULT:-"100/minute"}
    premium_limit: ${RATE_LIMIT_PREMIUM:-"500/minute"}
    admin_limit: ${RATE_LIMIT_ADMIN:-"1000/minute"}
    exclude_paths:
      - "/health"
      - "/metrics"
      - "/docs"
      - "/redoc"
      - "/openapi.json"

# Authentication
auth:
  enabled: true
  config:
    secret_key: ${SECRET_KEY}
    algorithm: ${JWT_ALGORITHM:-"HS256"}
    token_location: "headers"  # headers, cookies, or both
    cookie_name: "access_token"
    header_name: "Authorization"
    header_type: "Bearer"
    exclude_paths:
      - "/api/v1/auth/login"
      - "/api/v1/auth/register"
      - "/api/v1/auth/refresh"
      - "/api/v1/auth/verify"
      - "/health"
      - "/docs"
      - "/redoc"
      - "/openapi.json"
    auto_renew: true
    renewal_threshold: 300  # seconds before expiry

# Request/Response Validation
validation:
  enabled: true
  config:
    validate_request: true
    validate_response: true
    strict_validation: false
    exclude_paths:
      - "/health"
      - "/metrics"
      - "/webhooks/*"

# Caching
cache:
  enabled: ${CACHE_ENABLED:-true}
  config:
    storage: "redis"  # redis, memory
    default_ttl: ${CACHE_DEFAULT_TTL:-300}
    cache_control: true
    vary_headers:
      - "Authorization"
      - "Accept-Language"
    exclude_paths:
      - "/health"
      - "/metrics"
      - "/api/v1/auth/*"

# Request Logging
logging:
  enabled: true
  config:
    log_level: ${LOG_LEVEL:-INFO}
    format: "json"  # json, text
    include:
      - method
      - path
      - status_code
      - duration
      - client_ip
      - user_agent
      - request_id
    exclude_paths:
      - "/health"
      - "/metrics"
      - "/static/*"
    sensitive_headers:
      - "authorization"
      - "cookie"
      - "set-cookie"

# Metrics Collection
metrics:
  enabled: ${PROMETHEUS_ENABLED:-true}
  config:
    namespace: "goat_prediction"
    subsystem: "api_gateway"
    exclude_paths:
      - "/health"
      - "/metrics"
    custom_metrics:
      - name: "http_requests_total"
        help: "Total HTTP requests"
        labels: ["method", "endpoint", "status"]
      - name: "http_request_duration_seconds"
        help: "HTTP request duration in seconds"
        labels: ["method", "endpoint"]

# Response Compression
compression:
  enabled: true
  config:
    min_size: ${GZIP_MIN_SIZE:-1000}
    compression_level: ${GZIP_COMPRESSION_LEVEL:-6}
    content_types:
      - "application/json"
      - "application/javascript"
      - "text/css"
      - "text/html"
      - "text/plain"
      - "text/xml"
    exclude_paths:
      - "/health"
      - "/metrics"

# Custom middleware (if any)
custom:
  request_id:
    enabled: true
    config:
      header_name: "X-Request-ID"
      include_in_response: true
  
  request_timing:
    enabled: true
    config:
      header_name: "X-Response-Time"
      unit: "ms"
  
  request_size:
    enabled: true
    config:
      max_size: ${MAX_UPLOAD_SIZE:-10485760}  # 10MB
      error_message: "Request too large"
  
  concurrency_limit:
    enabled: ${ENVIRONMENT:-development} == "production"
    config:
      max_concurrent: ${MAX_WORKERS:-4}
      queue_size: 100
  
  circuit_breaker:
    enabled: ${ENVIRONMENT:-development} == "production"
    config:
      failure_threshold: 5
      recovery_timeout: 60
      excluded_endpoints:
        - "/health"
        - "/api/v1/auth/*"
