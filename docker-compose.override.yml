version: '3.8'

services:
  # API Gateway Development Configuration
  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile.dev
    ports:
      - "8000:8000"
    volumes:
      - ./backend/api-gateway:/app
      - ./backend/api-gateway/logs:/app/logs
      - /app/__pycache__
      - /app/.pytest_cache
    environment:
      ENVIRONMENT: development
      DATABASE_URL: postgresql://dev_user:dev_password@postgres:5432/goat_prediction_dev
      REDIS_URL: redis://:dev_redis_password@redis:6379/0
      JWT_SECRET: dev_jwt_secret_key_for_development_only_12345
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001,http://localhost:8080
      LOG_LEVEL: DEBUG
      DEBUG: "true"
      RELOAD: "true"
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        sleep 5 &&
        alembic upgrade head &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
      "
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Prediction Engine Development Configuration
  prediction-engine:
    build:
      context: ./backend/prediction-engine
      dockerfile: Dockerfile.dev
    ports:
      - "8001:8000"
    volumes:
      - ./backend/prediction-engine:/app
      - ./backend/prediction-engine/logs:/app/logs
      - ./data/development:/app/data
      - ./models/development:/app/models
      - /app/__pycache__
      - /app/.pytest_cache
    environment:
      ENVIRONMENT: development
      POSTGRES_URL: postgresql://dev_user:dev_password@postgres:5432/goat_prediction_dev
      TIMESCALE_URL: postgresql://timescale_dev:timescale_dev_password@timescaledb:5432/goat_prediction_timeseries_dev
      REDIS_URL: redis://:dev_redis_password@redis:6379/0
      ML_MODELS_PATH: /app/models/development
      DATA_CACHE_PATH: /app/data/cache
      LOG_LEVEL: DEBUG
      DEBUG: "true"
      RELOAD: "true"
      MLFLOW_TRACKING_URI: http://mlflow:5000
    command: >
      sh -c "
        echo 'Waiting for services...' &&
        sleep 10 &&
        echo 'Initializing models...' &&
        python scripts/initialize_models.py --dev &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
      "
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      mlflow:
        condition: service_started

  # Frontend Development Configuration
  frontend:
    build:
      context: ./frontend/web-app
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
      - "9229:9229"  # Node.js debug port
    volumes:
      - ./frontend/web-app:/app
      - /app/node_modules
      - /app/.next
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:8000
      NEXT_PUBLIC_WS_URL: ws://localhost:8001/ws
      NEXT_TELEMETRY_DISABLED: 1
      WATCHPACK_POLLING: "true"
    command: npm run dev
    stdin_open: true
    tty: true
    depends_on:
      - api-gateway
      - prediction-engine

  # PostgreSQL Development Configuration
  postgres:
    volumes:
      - postgres-dev-data:/var/lib/postgresql/data
      - ./database/supabase/migrations:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: dev_user
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: goat_prediction_dev
      POSTGRES_MULTIPLE_EXTENSIONS: postgis,pg_trgm,btree_gin,btree_gist
    ports:
      - "5432:5432"
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.7
      -c wal_buffers=4MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB

  # TimescaleDB Development Configuration
  timescaledb:
    volumes:
      - timescaledb-dev-data:/var/lib/postgresql/data
      - ./database/timescaledb/hypertables:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: timescale_dev
      POSTGRES_PASSWORD: timescale_dev_password
      POSTGRES_DB: goat_prediction_timeseries_dev
    ports:
      - "5433:5432"
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=768MB
      -c maintenance_work_mem=64MB

  # Redis Development Configuration
  redis:
    command: redis-server --appendonly yes --requirepass dev_redis_password
    ports:
      - "6379:6379"
    volumes:
      - redis-dev-data:/data

  # Kafka Development Configuration
  kafka:
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  # Zookeeper Development Configuration
  zookeeper:
    ports:
      - "2181:2181"

  # Elasticsearch Development Configuration
  elasticsearch:
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch-dev-data:/usr/share/elasticsearch/data

  # Kibana Development Configuration
  kibana:
    image: kibana:8.11.0
    container_name: goat-prediction-kibana-dev
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  # MLflow Development Configuration
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: goat-prediction-mlflow-dev
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      MLFLOW_TRACKING_URI: sqlite:///mlflow.db
      MLFLOW_S3_IGNORE_TLS: "true"
    ports:
      - "5000:5000"
    volumes:
      - mlflow-dev-data:/mlflow
      - ./mlops/experiment-tracking:/experiments
    command: >
      mlflow server
      --backend-store-uri sqlite:///mlflow.db
      --default-artifact-root s3://mlflow-artifacts/
      --host 0.0.0.0
      --port 5000

  # MinIO Development Configuration
  minio:
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-dev-data:/data

  # Prometheus Development Configuration
  prometheus:
    volumes:
      - ./infrastructure/monitoring/prometheus/prometheus.dev.yml:/etc/prometheus/prometheus.yml
      - prometheus-dev-data:/prometheus
    ports:
      - "9090:9090"

  # Grafana Development Configuration
  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    ports:
      - "3001:3000"
    volumes:
      - grafana-dev-data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning/dev:/etc/grafana/provisioning

  # Adminer for Database Management
  adminer:
    image: adminer:latest
    container_name: goat-prediction-adminer
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres

  # PGAdmin for PostgreSQL Management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: goat-prediction-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@goat-prediction.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "5050:80"
    volumes:
      - pgadmin-dev-data:/var/lib/pgadmin
    depends_on:
      - postgres

  # Redis Commander for Redis Management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: goat-prediction-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:dev_redis_password
    ports:
      - "8081:8081"
    depends_on:
      - redis

  # Mailhog for Email Testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: goat-prediction-mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    environment:
      MH_STORAGE: maildir
      MH_MAILDIR_PATH: /maildir

  # Portainer for Container Management
  portainer:
    image: portainer/portainer-ce:latest
    container_name: goat-prediction-portainer
    ports:
      - "9000:9000"
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    command: -H unix:///var/run/docker.sock --ssl --sslcert /certs/portainer.crt --sslkey /certs/portainer.key

  # Jaeger for Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: goat-prediction-jaeger
    ports:
      - "16686:16686"  # Web UI
      - "14268:14268"  # Collector
      - "9411:9411"    # Zipkin
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: :9411
      COLLECTOR_OTLP_ENABLED: true

  # Localstack for AWS Services Mocking
  localstack:
    image: localstack/localstack:latest
    container_name: goat-prediction-localstack
    ports:
      - "4566:4566"  # All services
      - "4571:4571"  # S3
      - "4572:4572"  # SQS
    environment:
      SERVICES: s3,sqs,sns,secretsmanager
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - localstack-data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock

  # Database Seed Service
  db-seed:
    build:
      context: ./database
      dockerfile: Dockerfile.dev
    container_name: goat-prediction-db-seed
    depends_on:
      postgres:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    environment:
      POSTGRES_URL: postgresql://dev_user:dev_password@postgres:5432/goat_prediction_dev
      TIMESCALE_URL: postgresql://timescale_dev:timescale_dev_password@timescaledb:5432/goat_prediction_timeseries_dev
    volumes:
      - ./database/supabase/seeds:/seeds
      - ./data/development:/data
    command: >
      sh -c "
        echo 'Waiting for databases...' &&
        sleep 10 &&
        echo 'Seeding development database...' &&
        psql $$POSTGRES_URL -f /seeds/sports_data.sql &&
        echo 'Seeding timescale database...' &&
        psql $$TIMESCALE_URL -f /seeds/timeseries_data.sql &&
        echo 'Database seeding complete!'
      "

  # Development Tools Service
  dev-tools:
    image: python:3.11-slim
    container_name: goat-prediction-dev-tools
    volumes:
      - ./backend:/backend
      - ./scripts:/scripts
      - ./data/development:/data
    working_dir: /backend
    command: tail -f /dev/null
    ports:
      - "8888:8888"  # Jupyter Notebook
    environment:
      JUPYTER_ENABLE_LAB: "yes"
      JUPYTER_TOKEN: dev123
      PYTHONPATH: /backend

volumes:
  postgres-dev-data:
  timescaledb-dev-data:
  redis-dev-data:
  elasticsearch-dev-data:
  mlflow-dev-data:
  minio-dev-data:
  prometheus-dev-data:
  grafana-dev-data:
  pgadmin-dev-data:
  portainer-data:
  localstack-data:
