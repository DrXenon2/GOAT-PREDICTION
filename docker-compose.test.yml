version: '3.8'

services:
  # PostgreSQL for testing
  postgres-test:
    image: postgres:15-alpine
    container_name: goat-prediction-postgres-test
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: goat_prediction_test
    ports:
      - "5433:5432"
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
      - ./database/supabase/migrations/001_initial_schema.sql:/docker-entrypoint-initdb.d/001_initial_schema.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for testing
  redis-test:
    image: redis:7-alpine
    container_name: goat-prediction-redis-test
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes --requirepass test_redis_password
    volumes:
      - redis-test-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # TimescaleDB for time-series data testing
  timescaledb-test:
    image: timescale/timescaledb:latest-pg15
    container_name: goat-prediction-timescaledb-test
    environment:
      POSTGRES_USER: timescale_test
      POSTGRES_PASSWORD: timescale_test_password
      POSTGRES_DB: goat_prediction_timeseries_test
    ports:
      - "5434:5432"
    volumes:
      - timescaledb-test-data:/var/lib/postgresql/data
      - ./database/timescaledb/hypertables/predictions_hypertable.sql:/docker-entrypoint-initdb.d/001_hypertables.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U timescale_test"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway Test
  api-gateway-test:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile.test
    container_name: goat-prediction-api-gateway-test
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      ENVIRONMENT: test
      DATABASE_URL: postgresql://test_user:test_password@postgres-test:5432/goat_prediction_test
      REDIS_URL: redis://:test_redis_password@redis-test:6379/0
      JWT_SECRET: test_jwt_secret_key_for_testing_only_12345
      CORS_ORIGINS: http://localhost:3000,http://localhost:3001
      LOG_LEVEL: DEBUG
    ports:
      - "8001:8000"
    volumes:
      - ./backend/api-gateway:/app
      - ./logs/test/api-gateway:/app/logs
    command: >
      sh -c "
        alembic upgrade head &&
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
      "

  # Prediction Engine Test
  prediction-engine-test:
    build:
      context: ./backend/prediction-engine
      dockerfile: Dockerfile.test
    container_name: goat-prediction-engine-test
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
      timescaledb-test:
        condition: service_healthy
    environment:
      ENVIRONMENT: test
      POSTGRES_URL: postgresql://test_user:test_password@postgres-test:5432/goat_prediction_test
      TIMESCALE_URL: postgresql://timescale_test:timescale_test_password@timescaledb-test:5432/goat_prediction_timeseries_test
      REDIS_URL: redis://:test_redis_password@redis-test:6379/0
      ML_MODELS_PATH: /app/models
      DATA_CACHE_PATH: /app/data/cache
      LOG_LEVEL: DEBUG
      TEST_MODE: "true"
    ports:
      - "8002:8000"
    volumes:
      - ./backend/prediction-engine:/app
      - ./data/test/cache:/app/data/cache
      - ./models/test:/app/models
      - ./logs/test/prediction-engine:/app/logs
    command: >
      sh -c "
        python scripts/train_test_models.py &&
        python -m pytest tests/ -v --tb=short --cov=src --cov-report=term-missing &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
      "

  # Kafka for testing
  kafka-test:
    image: confluentinc/cp-kafka:7.4.0
    container_name: goat-prediction-kafka-test
    depends_on:
      zookeeper-test:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-test:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_LOG_RETENTION_HOURS: 1
      KAFKA_LOG_RETENTION_BYTES: 1073741824
    ports:
      - "9093:9093"
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Zookeeper for Kafka
  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: goat-prediction-zookeeper-test
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2182:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Elasticsearch for logging and search testing
  elasticsearch-test:
    image: elasticsearch:8.11.0
    container_name: goat-prediction-elasticsearch-test
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.routing.allocation.disk.threshold_enabled=false
    ports:
      - "9201:9200"
      - "9301:9300"
    volumes:
      - elasticsearch-test-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Kibana for Elasticsearch visualization testing
  kibana-test:
    image: kibana:8.11.0
    container_name: goat-prediction-kibana-test
    depends_on:
      elasticsearch-test:
        condition: service_healthy
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch-test:9200
      XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY: d2a7c2b5e8f4a9c6b3d1e5f8a2b4c6d9
    ports:
      - "5602:5601"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5601/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus for metrics testing
  prometheus-test:
    image: prom/prometheus:latest
    container_name: goat-prediction-prometheus-test
    ports:
      - "9091:9090"
    volumes:
      - ./infrastructure/monitoring/prometheus/prometheus.test.yml:/etc/prometheus/prometheus.yml
      - prometheus-test-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=1h'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana for dashboard testing
  grafana-test:
    image: grafana/grafana:latest
    container_name: goat-prediction-grafana-test
    depends_on:
      prometheus-test:
        condition: service_healthy
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    ports:
      - "3002:3000"
    volumes:
      - grafana-test-data:/var/lib/grafana
      - ./infrastructure/monitoring/grafana/provisioning/test:/etc/grafana/provisioning
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MLflow for experiment tracking testing
  mlflow-test:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: goat-prediction-mlflow-test
    depends_on:
      postgres-test:
        condition: service_healthy
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://minio-test:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      MLFLOW_TRACKING_URI: postgresql://test_user:test_password@postgres-test:5432/goat_prediction_test
      MLFLOW_S3_IGNORE_TLS: "true"
    ports:
      - "5001:5000"
    volumes:
      - mlflow-test-data:/mlflow
    command: >
      mlflow server
      --backend-store-uri postgresql://test_user:test_password@postgres-test:5432/goat_prediction_test
      --default-artifact-root s3://mlflow-artifacts/
      --host 0.0.0.0
      --port 5000

  # MinIO for MLflow artifact storage testing
  minio-test:
    image: minio/minio:latest
    container_name: goat-prediction-minio-test
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9001:9000"
      - "9002:9001"
    volumes:
      - minio-test-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Test runner
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: goat-prediction-test-runner
    depends_on:
      api-gateway-test:
        condition: service_started
      prediction-engine-test:
        condition: service_started
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    environment:
      ENVIRONMENT: test
      API_GATEWAY_URL: http://api-gateway-test:8000
      PREDICTION_ENGINE_URL: http://prediction-engine-test:8000
      DATABASE_URL: postgresql://test_user:test_password@postgres-test:5432/goat_prediction_test
      REDIS_URL: redis://:test_redis_password@redis-test:6379/0
    volumes:
      - ./tests:/app/tests
      - ./backend:/app/backend
      - ./test-reports:/app/test-reports
    command: >
      sh -c "
        echo 'Waiting for services to be ready...' &&
        sleep 30 &&
        echo 'Running all tests...' &&
        python -m pytest tests/ -v --junitxml=/app/test-reports/junit.xml --cov=backend --cov-report=xml:/app/test-reports/coverage.xml --cov-report=html:/app/test-reports/coverage-html
      "

  # Mock APIs for testing
  mock-apis:
    image: mockserver/mockserver:latest
    container_name: goat-prediction-mock-apis
    ports:
      - "1080:1080"
    command: >
      -logLevel INFO
      -serverPort 1080
    volumes:
      - ./tests/mocks:/mocks
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1080/status"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres-test-data:
  redis-test-data:
  timescaledb-test-data:
  elasticsearch-test-data:
  prometheus-test-data:
  grafana-test-data:
  mlflow-test-data:
  minio-test-data:
