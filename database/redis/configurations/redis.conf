# database/redis/configurations/redis.conf
# Configuration Redis pour Goat Prediction
# Version: 2.0.0
# Date: 2026-01-16

# ============================================
# 1. CONFIGURATION GÉNÉRALE
# ============================================

# Répertoire de travail
dir /data

# Mode cluster
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip ${POD_IP}
cluster-announce-port 6379
cluster-announce-bus-port 16379

# Mode réplica
replica-read-only yes
replica-serve-stale-data yes
replica-priority 100

# Network
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ============================================
# 2. CONFIGURATION DE LA SÉCURITÉ
# ============================================

# Authentification
requirepass ${REDIS_PASSWORD}
masterauth ${REDIS_PASSWORD}

# Protection contre les attaques
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ACL (si Redis 6+)
aclfile /etc/redis/users.acl

# TLS (optionnel)
# tls-port 6379
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt
# tls-auth-clients yes

# ============================================
# 3. CONFIGURATION DE LA MÉMOIRE
# ============================================

# Mémoire maximale
maxmemory 8gb
maxmemory-policy allkeys-lru

# Overcommit mémoire
vm.overcommit_memory 1

# Transparent Huge Pages
disable-thp yes

# Swapping
vm.swappiness 1

# Configuration mémoire détaillée
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000

# ============================================
# 4. CONFIGURATION DE LA PERSISTANCE
# ============================================

# Sauvegarde RDB
save 900 1
save 300 10
save 60 10000

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
rdb-del-sync-files no

# Journal AOF
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# ============================================
# 5. CONFIGURATION DES RÉPLICAS
# ============================================

replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync yes
repl-diskless-sync-delay 5
repl-diskless-load disabled
repl-disable-tcp-nodelay no
replica-priority 100
min-replicas-to-write 1
min-replicas-max-lag 10

# ============================================
# 6. CONFIGURATION DU CLUSTER
# ============================================

cluster-enabled yes
cluster-config-file /data/nodes.conf
cluster-node-timeout 15000
cluster-replica-validity-factor 10
cluster-migration-barrier 1
cluster-require-full-coverage no
cluster-allow-reads-when-down no

# ============================================
# 7. CONFIGURATION DES PERFORMANCES
# ============================================

# IO threads
io-threads 4
io-threads-do-reads yes

# Connexions clients
maxclients 10000
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Latence monitoring
latency-monitor-threshold 100

# Lazy freeing
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# ============================================
# 8. CONFIGURATION DES LOGS
# ============================================

loglevel notice
logfile /var/log/redis/redis-server.log
syslog-enabled no
syslog-ident redis
syslog-facility local0

# Log slow queries
slowlog-log-slower-than 10000
slowlog-max-len 128

# ============================================
# 9. CONFIGURATION DES ÉVÉNEMENTS
# ============================================

notify-keyspace-events ""

# ============================================
# 10. CONFIGURATION AVANCÉE
# ============================================

# Lua scripting
lua-time-limit 5000

# HyperLogLog
hll-sparse-max-bytes 3000

# Streams
stream-node-max-bytes 4096
stream-node-max-entries 100

# Activer les modules
# loadmodule /path/to/module.so

# ============================================
# 11. CONFIGURATION SPÉCIFIQUE GOAT PREDICTION
# ============================================

# Cache des modèles ML
maxmemory 12gb
maxmemory-policy allkeys-lru

# Configuration spécifique aux données sportives
hash-max-ziplist-entries 1024
hash-max-ziplist-value 128

# Optimisation pour les séries temporelles
list-max-ziplist-size -2

# Pour les données de prédiction
zset-max-ziplist-entries 256
zset-max-ziplist-value 128

# Configuration des connexions
tcp-keepalive 60
timeout 300

# Persistence optimisée pour la production
appendonly yes
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 128mb

# Monitoring
latency-monitor-threshold 50
slowlog-log-slower-than 5000
slowlog-max-len 256

# ============================================
# 12. CONFIGURATION DU MONITORING
# ============================================

# Métriques activées
activerehashing yes

# Statistiques
statistics-interval 10

# ============================================
# 13. CONFIGURATION DE SANTÉ
# ============================================

# Health checks
repl-ping-replica-period 10
repl-timeout 60

# ============================================
# 14. VARIABLES D'ENVIRONNEMENT
# ============================================

# Les variables suivantes doivent être définies dans les secrets:
# - REDIS_PASSWORD
# - REDIS_MASTER_AUTH (pour les réplicas)
# - REDIS_NODE_ID (pour le cluster)

# ============================================
# 15. CONFIGURATION KUBERNETES
# ============================================

# Découverte de service
cluster-announce-ip ${POD_IP}
cluster-announce-port 6379
cluster-announce-bus-port 16379

# Persistence pour Kubernetes
dir /data
appenddirname "appendonlydir"
dbfilename dump.rdb

# Configuration du stockage
maxmemory 12gb
maxmemory-policy allkeys-lru

# ============================================
# 16. CONFIGURATION DES SENTINELLES
# ============================================

# Si utilisé en mode Sentinel
# sentinel monitor mymaster 127.0.0.1 6379 2
# sentinel down-after-milliseconds mymaster 30000
# sentinel parallel-syncs mymaster 1
# sentinel failover-timeout mymaster 180000

# ============================================
# 17. FICHIER DE CONFIGURATION COMPLÉMENTAIRE
# ============================================

# Inclure des configurations supplémentaires
include /etc/redis/conf.d/*.conf
